# my_backup1c

## Назначение
Утилита для автоматического резервного копирования файловых баз 1С:Предприятие 8.3. Скрипты создают копии в формате `.dt` или `.1cd`, могут останавливать сервисы перед выгрузкой и по желанию отправлять архив в Яндекс.Диск.

## Основные возможности
- выгрузка файловых баз 1С в формате `.dt` (через `1cv8.exe`) или копирование файла `.1CD`;
- автоматическое создание каталога назначений и ротация старых резервных копий по количеству (`Keep`);
- шифрованное хранение логинов/паролей и OAuth-токенов в `config/secrets.json.enc`;
- Если включена автоматическая чистка, убедитесь, что  `CloudKeep` задан и у токена есть права на удаление. 
- необязательная остановка выбранных сервисов (Apache, IIS и т. д.) на время дампа;
- выгрузка получившихся файлов в Яндекс.Диск;
- отправка итогового отчёта в Telegram (настраивается в мастере);
- ведение логов по каждой базе и общего журнала сессии.

## Требования
- Windows с PowerShell 5.1 (скрипты используют WinAPI и Windows Forms);
- установленный клиент 1С:Предприятие 8.3; для работы дампа `.dt` должен быть доступен `1cv8.exe` или `1cestart.exe`;
- права на запуск PowerShell-скриптов (`Run-Backup.cmd` и `Setup-Config.cmd` запускают их с `ExecutionPolicy Bypass`);
- для загрузки в облако — OAuth‑токен Яндекс.Диска с правами на запись.
- для Telegram-уведомлений — токен бота и ID чата.

## Структура проекта (`Beta2`)
- `Run-Backup.cmd` / `Run-Backup.ps1` — запуск резервного копирования для всех сконфигурированных баз;
- `Setup-Config.cmd` / `setup/SetupWizard.ps1` — мастер первичной настройки баз и секретов;
- `core/` — основной модуль `Pipeline.psm1` с логикой обработки каждой базы;
- `modules/` — вспомогательные модули (шифрование, логирование, выгрузка `.dt`, копирование `.1CD`, остановка сервисов, Яндекс.Диск, очистка облака);
- `config/` (создаётся мастером) — JSON-файлы конфигураций баз, шифрованные секреты, общий `settings.json`;
- `logs/` — журналы выполнения (создаются автоматически).

## Первичная настройка
1. Запустите `Setup-Config.cmd` (или напрямую `setup/SetupWizard.ps1`).
2. Укажите короткий тег базы (используется в именах файлов и логов).
3. Выберите тип резервного копирования:
   - «Файловая база .1CD» — будет скопирован исходный файл `1Cv8.1CD`;
   - «Выгрузка .dt через конфигуратор» — каталог базы будет выгружен в `.dt`.
4. Мастер попросит путь к источнику (файл или каталог), каталог назначения, количество сохраняемых копий и, при необходимости, `1cestart.exe`.
5. Для `.dt` можно задать логин/пароль и перечень сервисов, которые нужно остановить. При желании укажите, сколько последних файлов хранить в облаке (параметр `CloudKeep`).
6. При желании укажите OAuth-токен Яндекс.Диска — тогда готовые файлы будут отправляться в `/Backups1C/<TAG>`; мастер может отправить тестовый файл, чтобы проверить подключение.
7. Перед выбором действия с ПК решите, нужны ли Telegram-уведомления: введите токен бота, ID чата и выберите режим (всегда или только при ошибках); при желании мастер отправит тестовое сообщение для проверки.
8. Повторите шаги для всех баз. В конце мастер сохранит конфиги и спросит, что делать с ПК после завершения (значение `AfterBackup` в `config/settings.json`).

## Конфигурация
Каждая база описана в `config/bases/<TAG>.json`. Основные поля:

```json
{
  "BackupType": "DT",
  "SourcePath": "D:/1C/Bases/Retail",
  "DestinationPath": "D:/Backups/1C",
  "ExePath": "C:/Program Files/1cv8/common/1cestart.exe",
  "Keep": 7,
  "CloudKeep": 5,
  "StopServices": ["Apache2.4"],
  "CloudType": "Yandex.Disk",
  "Disabled": false
}
```

- `BackupType` — `DT` (выгрузка через конфигуратор) или `1CD` (копирование файла базы).
- `SourcePath` — каталог базы или путь к `1Cv8.1CD`.
- `DestinationPath` — папка для резервных копий.
- `ExePath` — путь к `1cestart.exe`; если не указан, скрипт попытается найти `1cv8.exe` в реестре.
- `Keep` — сколько последних копий хранить локально; старые файлы удаляются автоматически.
- `CloudKeep` — сколько последних файлов хранить в облаке (0 — чистка отключена).
- `StopServices` — массив имён сервисов Windows, которые нужно временно остановить.
- `CloudType` — `"Yandex.Disk"` для загрузки в облако или пустая строка.
- `Disabled` — `true`, чтобы пропустить базу без удаления файла конфигурации.

Общий файл `config/settings.json` содержит настройки завершения работы и уведомлений:

```json
{
  "AfterBackup": 3,
  "Telegram": {
    "Enabled": true,
    "ChatId": "-1001234567890",
    "NotifyOnlyOnErrors": false
  }
}
```

- `AfterBackup` — 1 — выключить ПК (`Stop-Computer -Force`), 2 — перезагрузить (`Restart-Computer -Force`), другое значение — оставить без действий.
- `Telegram.Enabled` — включает/выключает отправку отчётов.
- `Telegram.ChatId` — ID чата, канала или пользователя, куда отправлять сообщения.
- `Telegram.NotifyOnlyOnErrors` — `true`, чтобы отправлять отчёт только при наличии ошибок.

## Секреты и шифрование
- Файл `config/key.bin` создаётся автоматически и хранит ключ AES-256.
- `config/secrets.json.enc` содержит зашифрованные данные (логины, пароли, токены). Для каждой базы используются ключи вида `<TAG>__DT_Login`, `<TAG>__DT_Password`, `<TAG>__YADiskToken`.
- Для Telegram используется ключ `__TELEGRAM_BOT_TOKEN`, в котором хранится токен бота.
- Изменить или добавить секреты можно повторным запуском мастера настройки либо вручную (раскодировать/закодировать при помощи функций из `modules/Common.Crypto.psm1`).

## Запуск резервного копирования
- Запустите `Run-Backup.cmd` (удобно для ручного старта и задач Планировщика). Он вызывает `Run-Backup.ps1`, который последовательно обрабатывает все JSON-файлы в `config/bases`.
- Логи сессии пишутся в `logs/backup_<дата>.log`, а детальные сообщения по каждой базе добавляются в тот же файл с префиксом тега.
- При включённых уведомлениях после завершения выполнения отправляется краткий отчёт в Telegram.
- Для дампа `.dt` дополнительно создаётся файл `*.designer.log` рядом с выгрузкой.
- Скрипт поддерживает повторный запуск: пропущенные базы с `Disabled=true` не обрабатываются, остальные — выгружаются по очереди.

## Планирование
Чтобы выполнять резервное копирование по расписанию:
1. Создайте задачу в Планировщике Windows.
2. В поле «Действие» укажите запуск `Run-Backup.cmd` из каталога `Beta2`.
3. При необходимости установите запуск от имени пользователя с правами на каталоги базы и папку назначения.

## Устранение неполадок
- При ошибках смотрите сообщения в `logs/backup_*.log` и в индивидуальных `*.designer.log`.
- Убедитесь, что выбранные сервисы действительно существуют; иначе остановка/запуск будет записан в лог с предупреждением.
- Если выгрузка `.dt` зависает, проверьте права пользователя и убедитесь, что процесс `1cv8.exe` завершается корректно.
- При работе с Яндекс.Диском проверяйте актуальность OAuth-токена.
